<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>道路標線施工統計工具</title>
    <!-- 引入 Tailwind CSS 用於快速樣式 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 引入 html2pdf.js 用於輸出 PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* 禁止選取文字，避免按鈕操作時誤選 */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* 隱藏數字輸入框的箭頭 */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* 點擊效果 */
        .btn-active:active {
            transform: scale(0.95);
        }
        /* 自定義捲軸樣式 */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 2px;
        }
        
        /* 頁面切換動畫 */
        .page-hidden {
            display: none !important;
        }
        .page-visible {
            display: flex !important;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 選項按鈕樣式 */
        .option-btn {
            transition: all 0.2s;
        }
        .option-btn.selected {
            background-color: #eff6ff; /* blue-50 */
            border-color: #3b82f6; /* blue-500 */
            color: #1d4ed8; /* blue-700 */
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1), 0 2px 4px -1px rgba(59, 130, 246, 0.06);
        }

        /* 鍵盤焦點樣式 */
        .keyboard-focused {
            outline: 3px solid #f59e0b; /* Amber-500 */
            outline-offset: 2px;
            z-index: 50;
            transform: scale(1.02);
            background-color: #fffbeb !important; /* Amber-50 */
        }

        /* 模式切換按鈕樣式 */
        .mode-btn-active {
            background-color: #fff;
            color: #2563eb; /* blue-600 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-weight: 700;
        }
        .mode-btn-inactive {
            color: #64748b; /* slate-500 */
            font-weight: 500;
        }
        .mode-btn-inactive:hover {
            background-color: rgba(255,255,255,0.5);
        }
        /* 隱藏捲軸 */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* PDF 輸出專用樣式 - 預設隱藏 */
        #pdf-template {
            display: none;
            width: 100%;
            max-width: 210mm; /* A4 width constraint */
            margin: 0 auto;
            padding: 10mm;
            background: white;
            color: black;
            font-family: "Microsoft JhengHei", "PingFang TC", "Heiti TC", sans-serif;
        }
        
        /* 當進入 PDF 模式時，此 Class 會被加到 Body */
        body.pdf-mode {
            background-color: white !important;
            overflow: visible !important; /* 允許滾動以便截圖 */
            height: auto !important; /* 修正：強制解除高度限制，避免截圖被切斷 */
            min-height: 100vh !important;
        }
        body.pdf-mode #start-page,
        body.pdf-mode #main-app, 
        body.pdf-mode #modal-custom,
        body.pdf-mode #toast {
            display: none !important; /* 強制隱藏所有 UI */
        }
        body.pdf-mode #pdf-template {
            display: block !important; /* 只顯示 PDF 模板 */
        }

        .pdf-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .pdf-section {
            break-inside: avoid;
            margin-bottom: 15px;
        }
        .pdf-header-item {
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans h-screen flex flex-col overflow-hidden" onclick="initAudioContext()">

    <!-- ==================== 前置作業表單頁面 (Start Page) ==================== -->
    <div id="start-page" class="page-visible flex-col h-full w-full bg-slate-50 overflow-hidden">
        
        <!-- 頂部標題 -->
        <header class="bg-white p-3 shadow-sm border-b border-slate-200 z-20 flex justify-between items-center shrink-0">
            <div class="flex items-center gap-2">
                <div class="p-1.5 bg-blue-100 rounded-lg">
                    <i data-lucide="clipboard-list" class="w-5 h-5 text-blue-600"></i>
                </div>
                <div>
                    <h1 class="font-bold text-base leading-tight">施工前置作業</h1>
                    <p class="text-[10px] text-slate-400">鍵盤操作: W/S/A/D 移動，空白鍵選取，Enter 下一步</p>
                </div>
            </div>
            <!-- 聲音開關 -->
            <button onclick="toggleSound()" id="sound-btn-start" class="text-slate-400 p-2 rounded-full hover:bg-slate-100">
                <i data-lucide="volume-2" class="w-5 h-5"></i>
            </button>
        </header>

        <!-- 滾動內容區 -->
        <div class="flex-1 overflow-y-auto p-4 space-y-6" id="form-container">
            <!-- 日期 -->
            <section>
                <h3 class="text-xs font-bold text-slate-500 mb-2 flex items-center gap-1">
                    <i data-lucide="calendar" class="w-3 h-3"></i> 施工日期
                </h3>
                <input type="date" id="form-date" class="w-full p-3 bg-white border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-slate-700 font-mono font-bold shadow-sm nav-item" data-section="date">
            </section>
            <!-- JS 動態生成其他區塊 -->
            <div id="dynamic-form-sections" class="space-y-6"></div>
            <!-- 底部留白 -->
            <div class="h-20"></div>
        </div>

        <!-- 底部固定按鈕 -->
        <div class="p-4 bg-white border-t border-slate-200 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-30">
            <button id="btn-start-calc" onclick="goToCalculator()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold text-lg shadow-lg shadow-blue-200 active:scale-95 transition-all flex items-center justify-center gap-2 nav-item" data-section="submit">
                開始統計 (Enter)
                <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <!-- ==================== 主程式頁面 (Main App) ==================== -->
    <div id="main-app" class="page-hidden flex-col h-full w-full overflow-hidden">
        
        <!-- 頂部標題與總計 -->
        <header class="bg-white p-2 shadow-sm border-b border-slate-200 z-20 flex justify-between items-center shrink-0 h-14">
            <div class="flex items-center gap-1.5 overflow-hidden flex-1 min-w-0 mr-2">
                <!-- 返回按鈕 -->
                <button onclick="backToForm()" class="text-slate-400 hover:text-slate-600 mr-1 p-1 rounded hover:bg-slate-100 shrink-0">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </button>
                <div class="flex flex-col min-w-0">
                    <h1 id="project-title" class="font-bold text-sm leading-tight text-slate-800 truncate">標線統計</h1>
                    <p id="project-subtitle" class="text-[10px] text-slate-500 truncate">請先填寫前置資料</p>
                </div>
            </div>
            <div class="text-right flex flex-col justify-center shrink-0 pl-2">
                <div class="text-[10px] text-slate-400 uppercase leading-none mb-0.5">總計</div>
                <div class="text-lg font-bold text-blue-600 font-mono leading-none">
                    <span id="display-total-area">0.00</span> <span class="text-[10px] text-slate-500">m²</span>
                </div>
            </div>
        </header>

        <!-- 主內容區 -->
        <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
            
            <!-- 左側：操作面板 -->
            <div class="flex-1 flex flex-col md:w-3/5 h-full overflow-hidden">
                <!-- 類型選擇區 -->
                <div class="flex-1 p-1.5 overflow-y-auto bg-slate-50 relative" id="type-scroll-container">
                    <div class="flex justify-between items-center sticky top-0 bg-slate-50 py-1 z-20 mb-1 shadow-sm px-1 flex-wrap gap-y-1">
                        <div class="flex items-center gap-2 max-w-full">
                            <h2 class="text-xs font-bold text-slate-500 flex items-center gap-1 shrink-0">
                                <i data-lucide="grid" class="w-3 h-3"></i> 1. 類型
                            </h2>
                            <!-- 模式切換按鈕群組 -->
                            <div class="flex items-center bg-slate-200 rounded p-0.5 shrink-0 overflow-x-auto max-w-[220px] sm:max-w-none scrollbar-hide">
                                <button onclick="setPrefixMode('mark')" id="btn-mode-mark" class="px-2 py-0.5 text-[10px] rounded transition-all mode-btn-active whitespace-nowrap">標線</button>
                                <button onclick="setPrefixMode('primer')" id="btn-mode-primer" class="px-2 py-0.5 text-[10px] rounded transition-all mode-btn-inactive whitespace-nowrap">底油</button>
                                <button onclick="setPrefixMode('remove')" id="btn-mode-remove" class="px-2 py-0.5 text-[10px] rounded transition-all mode-btn-inactive whitespace-nowrap">刨除</button>
                                <button onclick="setPrefixMode('black')" id="btn-mode-black" class="px-2 py-0.5 text-[10px] rounded transition-all mode-btn-inactive whitespace-nowrap">黑漆</button>
                                <button onclick="setPrefixMode('color')" id="btn-mode-color" class="px-2 py-0.5 text-[10px] rounded transition-all mode-btn-inactive whitespace-nowrap">彩標</button>
                                <button onclick="setPrefixMode('cold')" id="btn-mode-cold" class="px-2 py-0.5 text-[10px] rounded transition-all mode-btn-inactive whitespace-nowrap">冷塑</button>
                            </div>
                        </div>
                        <div class="flex gap-2 ml-auto">
                            <button onclick="toggleSound()" id="sound-btn-main" class="text-[10px] text-slate-400 flex items-center gap-1">
                                <i data-lucide="volume-2" class="w-3 h-3"></i>
                            </button>
                            <button onclick="resetTypes()" class="text-[10px] text-blue-500 underline px-2">恢復預設</button>
                        </div>
                    </div>
                    <div id="type-list-container" class="pb-10 space-y-2"></div>
                </div>

                <!-- 輸入與鍵盤區 -->
                <div class="bg-white p-2 border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20 shrink-0">
                    <div class="bg-slate-100 rounded-lg p-1.5 mb-1.5 text-right border border-slate-200 flex flex-col justify-center h-12 relative group">
                        <div class="absolute top-1 left-2 flex items-center gap-2">
                            <div id="screen-prefix-badge" class="hidden text-[9px] bg-slate-800 text-white px-1 py-0.5 rounded font-bold"></div>
                            <div id="screen-type-name" class="text-[10px] text-slate-500 font-bold truncate max-w-[120px]">請選擇</div>
                            <button onclick="editCurrentFactors()" class="bg-slate-200 hover:bg-slate-300 text-slate-600 rounded px-1 py-0.5 text-[9px] flex items-center gap-0.5 transition-colors" title="修改規格">
                                <i data-lucide="settings-2" class="w-3 h-3"></i> 修改
                            </button>
                        </div>
                        <div class="flex items-baseline justify-end gap-1 px-1">
                            <span id="screen-value" class="text-xl font-mono font-bold text-slate-800 leading-none">0</span>
                            <span id="screen-unit" class="text-[10px] text-slate-400">m</span>
                        </div>
                        <div id="screen-calc-preview" class="text-[9px] text-blue-500 h-3 truncate px-1 font-mono"></div>
                    </div>
                    <!-- 數字鍵盤 -->
                    <div class="grid grid-cols-4 gap-1 select-none pb-1">
                        <button class="key-btn bg-white border-b-2 border-slate-200 h-10 text-sm" onclick="inputKey('7')">7</button>
                        <button class="key-btn bg-white border-b-2 border-slate-200 h-10 text-sm" onclick="inputKey('8')">8</button>
                        <button class="key-btn bg-white border-b-2 border-slate-200 h-10 text-sm" onclick="inputKey('9')">9</button>
                        <button class="key-btn bg-red-50 text-red-500 border border-red-100 h-10 text-sm" onclick="inputKey('DEL')"><i data-lucide="delete" class="w-4 h-4 mx-auto"></i></button>
                        
                        <button class="key-btn bg-white border-b-2 border-slate-200 h-10 text-sm" onclick="inputKey('4')">4</button>
                        <button class="key-btn bg-white border-b-2 border-slate-200 h-10 text-sm" onclick="inputKey('5')">5</button>
                        <button class="key-btn bg-white border-b-2 border-slate-200 h-10 text-sm" onclick="inputKey('6')">6</button>
                        <button class="key-btn bg-red-50 text-red-500 border border-red-100 h-10 text-sm" onclick="inputKey('AC')">AC</button>
                        
                        <button class="key-btn bg-white border-b-2 border-slate-200 h-10 text-sm" onclick="inputKey('1')">1</button>
                        <button class="key-btn bg-white border-b-2 border-slate-200 h-10 text-sm" onclick="inputKey('2')">2</button>
                        <button class="key-btn bg-white border-b-2 border-slate-200 h-10 text-sm" onclick="inputKey('3')">3</button>
                        <button class="key-btn row-span-2 bg-blue-600 text-white rounded-lg shadow-md active:bg-blue-700 flex flex-col items-center justify-center gap-0.5" onclick="submitInput()">
                            <span class="text-sm font-bold">確認</span>
                            <span class="text-[9px] font-normal opacity-80">(Enter)</span>
                        </button>

                        <button class="key-btn col-span-2 bg-white border-b-2 border-slate-200 h-10 text-sm" onclick="inputKey('0')">0</button>
                        <button class="key-btn bg-white border-b-2 border-slate-200 h-10 text-sm" onclick="inputKey('.')">.</button>
                    </div>
                </div>
            </div>

            <!-- 右側：列表區 -->
            <div class="flex flex-col md:w-80 lg:w-96 bg-slate-50 border-t md:border-t-0 md:border-l border-slate-200 h-[35vh] md:h-full shrink-0">
                <div class="p-2 border-b border-slate-200 bg-white flex justify-between items-center shadow-sm h-8 shrink-0">
                    <div class="flex items-center gap-2">
                        <button onclick="addPartition()" class="bg-gray-700 hover:bg-gray-800 text-white text-[10px] px-2 py-1 rounded shadow-sm font-bold" title="新增分區分隔線">分區</button>
                        <h3 class="font-bold text-slate-700 text-xs flex items-center gap-1">
                            <i data-lucide="history" class="w-3 h-3"></i> 統計列表
                        </h3>
                    </div>
                    <button onclick="clearAll()" class="text-[10px] text-red-500 border border-red-200 px-1.5 py-0.5 rounded hover:bg-red-50">清空</button>
                </div>
                <div id="history-list" class="flex-1 overflow-y-auto p-1.5 space-y-1 bg-slate-100">
                    <div class="text-center text-slate-400 mt-4 text-xs">暫無資料</div>
                </div>
                
                <!-- 功能按鈕區：儲存/讀取/報表/逐條/PDF -->
                <div class="p-2 bg-white border-t border-slate-200 shrink-0 space-y-2">
                    <div class="grid grid-cols-2 gap-2">
                         <button onclick="saveProgress()" class="py-2 bg-emerald-600 text-white rounded-lg font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-1 text-xs">
                            <i data-lucide="save" class="w-3 h-3"></i> 儲存 (S)
                        </button>
                         <button onclick="loadProgress()" class="py-2 bg-amber-500 text-white rounded-lg font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-1 text-xs">
                            <i data-lucide="folder-open" class="w-3 h-3"></i> 讀取 (R)
                        </button>
                        <button onclick="copyReport()" class="py-2 bg-slate-800 text-white rounded-lg font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-1 text-xs">
                            <i data-lucide="clipboard-copy" class="w-3 h-3"></i> 報表 (P)
                        </button>
                        <button onclick="copyLineItems()" class="py-2 bg-blue-600 text-white rounded-lg font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-1 text-xs">
                            <i data-lucide="file-text" class="w-3 h-3"></i> 逐條 (O)
                        </button>
                    </div>
                    <button onclick="exportPDF()" class="w-full py-3 bg-red-600 text-white rounded-lg font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 text-sm">
                        <i data-lucide="file-down" class="w-4 h-4"></i> 輸出 PDF (L)
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- 隱藏的檔案輸入框，用於讀取檔案 -->
    <input type="file" id="file-input" accept=".json" class="hidden" onchange="handleFileLoad(this)">

    <!-- PDF 模板 (隱藏) -->
    <div id="pdf-template">
        <h1 class="text-2xl font-bold mb-4 text-center border-b-2 border-black pb-2">道路標線施工數量表</h1>
        <div class="grid grid-cols-2 gap-4 mb-4 text-sm font-bold">
            <div class="pdf-header-item">日期: <span id="pdf-date"></span></div>
            <div class="pdf-header-item">業主: <span id="pdf-owner"></span></div>
            <div class="pdf-header-item">人員: <span id="pdf-user"></span></div>
            <div class="pdf-header-item">狀態: <span id="pdf-status"></span></div>
            <div class="pdf-header-item">地點: <span id="pdf-location"></span></div>
            <div class="pdf-header-item">車輛: <span id="pdf-car"></span></div>
        </div>
        <div class="pdf-grid">
            <div class="bg-slate-50 p-4 rounded border border-slate-200">
                <h2 class="text-lg font-bold mb-3 border-b border-slate-300 pb-1 text-blue-800">數量統計</h2>
                <div id="pdf-left-col" class="text-xs space-y-4 font-mono leading-relaxed"></div>
                <div class="mt-4 pt-2 border-t-2 border-black font-bold text-sm text-right">
                    總計: <span id="pdf-total-area"></span> m²
                </div>
            </div>
            <div class="bg-white p-4 rounded border border-slate-200">
                <div class="flex justify-between items-center mb-3 border-b border-slate-300 pb-1">
                    <h2 class="text-lg font-bold text-slate-700">輸入紀錄</h2>
                    <span class="text-xs bg-slate-200 px-2 py-1 rounded-full text-slate-600" id="pdf-count-badge"></span>
                </div>
                <ol id="pdf-right-col" class="text-xs list-decimal pl-5 space-y-1 text-slate-600 font-mono"></ol>
            </div>
        </div>
    </div>

    <!-- Modal 與 Toast -->
    <div id="modal-custom" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-5 shadow-2xl transform transition-all scale-100">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i data-lucide="plus-circle" class="text-blue-600"></i> 新增自訂項目
            </h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">項目名稱</label>
                    <input type="text" id="custom-name" placeholder="例如：特殊圖案" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">計算方式</label>
                        <select id="custom-type" class="w-full p-2 border border-slate-300 rounded-lg bg-white" onchange="updateCustomLabels()">
                            <option value="linear">長度 (m)</option>
                            <option value="count">數量 (個/點/條)</option>
                            <option value="item">計次 (無面積)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1" id="custom-value-label">係數</label>
                        <input type="text" id="custom-factors" placeholder="例如: 1*0.1" class="w-full p-2 border border-slate-300 rounded-lg">
                    </div>
                </div>
                <div class="text-xs text-slate-400 bg-slate-100 p-2 rounded">
                    預覽公式：<span id="custom-preview" class="font-mono">1m * ? = ?m²</span>
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="closeModal()" class="flex-1 py-2 text-slate-500 font-bold bg-slate-100 rounded-lg hover:bg-slate-200">取消</button>
                <button onclick="saveCustomType()" class="flex-1 py-2 text-white font-bold bg-blue-600 rounded-lg hover:bg-blue-700 shadow-md">新增</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-6 py-4 rounded-xl shadow-2xl z-50 hidden flex-col items-center">
        <i data-lucide="check-circle" class="w-8 h-8 text-green-400 mb-2"></i>
        <div class="font-bold text-lg">操作成功！</div>
        <div class="text-sm text-gray-300 mt-1" id="toast-msg"></div>
    </div>

    <script>
        // ----------------------
        // 0. 音效與語音系統
        // ----------------------
        let audioCtx = null;
        let isSoundEnabled = true;

        function initAudioContext() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            } else if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function toggleSound() {
            isSoundEnabled = !isSoundEnabled;
            const btns = [document.getElementById('sound-btn-start'), document.getElementById('sound-btn-main')];
            btns.forEach(btn => {
                if(!btn) return;
                if (isSoundEnabled) {
                    btn.classList.remove('text-red-400');
                    btn.classList.add('text-slate-400');
                    btn.innerHTML = '<i data-lucide="volume-2" class="w-5 h-5"></i>';
                } else {
                    btn.classList.remove('text-slate-400');
                    btn.classList.add('text-red-400');
                    btn.innerHTML = '<i data-lucide="volume-x" class="w-5 h-5"></i>';
                }
            });
            lucide.createIcons();
        }

        function speak(text) {
            if (!isSoundEnabled || !window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW';
            utterance.rate = 1.2; 
            utterance.volume = 1.0; 
            window.speechSynthesis.speak(utterance);
        }

        function playDingDong() {
            if (!isSoundEnabled || !audioCtx) return;
            initAudioContext();
            const t = audioCtx.currentTime;
            const osc1 = audioCtx.createOscillator();
            const gain1 = audioCtx.createGain();
            osc1.type = 'sine';
            osc1.frequency.setValueAtTime(1046.5, t);
            gain1.gain.setValueAtTime(0.8, t); 
            gain1.gain.exponentialRampToValueAtTime(0.01, t + 0.8); 
            osc1.connect(gain1);
            gain1.connect(audioCtx.destination);
            osc1.start(t);
            osc1.stop(t + 0.8);

            const osc2 = audioCtx.createOscillator();
            const gain2 = audioCtx.createGain();
            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(783.99, t + 0.2); 
            gain2.gain.setValueAtTime(0.6, t + 0.2);
            gain2.gain.exponentialRampToValueAtTime(0.01, t + 1.5); 
            osc2.connect(gain2);
            gain2.connect(audioCtx.destination);
            osc2.start(t + 0.2);
            osc2.stop(t + 1.5);
        }

        function playStartSound() {
            if (!isSoundEnabled || !audioCtx) return;
            initAudioContext();
            const t = audioCtx.currentTime;
            const notes = [261.63, 329.63, 392.00, 523.25];
            notes.forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(freq, t + i * 0.08);
                gain.gain.setValueAtTime(0.3, t + i * 0.08);
                gain.gain.exponentialRampToValueAtTime(0.01, t + i * 0.08 + 0.3);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(t + i * 0.08);
                osc.stop(t + i * 0.08 + 0.3);
            });
        }
        
        function playBackSound() {
            if (!isSoundEnabled || !audioCtx) return;
            initAudioContext();
            const t = audioCtx.currentTime;
            const notes = [523.25, 392.00, 329.63, 261.63];
            notes.forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(freq, t + i * 0.08);
                gain.gain.setValueAtTime(0.3, t + i * 0.08);
                gain.gain.exponentialRampToValueAtTime(0.01, t + i * 0.08 + 0.3);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(t + i * 0.08);
                osc.stop(t + i * 0.08 + 0.3);
            });
        }

        function playVictory() {
            if (!isSoundEnabled || !audioCtx) return;
            initAudioContext();
            const t = audioCtx.currentTime;
            const notes = [1046.50, 1318.51, 1567.98, 2093.00]; 
            const duration = 0.12; 
            notes.forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'square'; 
                osc.frequency.setValueAtTime(freq, t + i * duration);
                const noteDur = (i === notes.length - 1) ? 0.8 : duration;
                const vol = (i === notes.length - 1) ? 0.4 : 0.3; 
                gain.gain.setValueAtTime(vol, t + i * duration);
                gain.gain.exponentialRampToValueAtTime(0.01, t + i * duration + noteDur - 0.05);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(t + i * duration);
                osc.stop(t + i * duration + noteDur);
            });
        }

        // ----------------------
        // 1. 前置作業資料與邏輯
        // ----------------------
        const FORM_OPTIONS = {
            user: ["陳易璘", "吳文龍", "陳清建", "呂世欽", "邱宗賢", "周啟智", "許朝淵", "廖旻揆", "莊盛傑", "張成億", "李祐緯", "詹哲豪", "劉文傑", "09-阿里芬", "21-亞納", "23-蘇南迪"],
            status: ["已完工", "未完工"],
            shift: ["早班", "晚班", "加班", "支援", "臨時", "其他"],
            owner: ["磐碩8上", "磐碩8下", "磐碩", "磐碩專案1標", "磐碩2區", "磐碩巡查3標", "磐碩大園", "磐碩專案5標", "磐碩巡查6標", "矽昌", "冠筑", "磐碩公I標", "皇昌", "磐碩公J標", "松盛3區", "磐碩(峰)4區", "松盛力元"],
            location: [
                {
                    label: "臺北市（12個區）",
                    options: ["中正區", "大同區", "中山區", "萬華區", "信義區", "松山區", "大安區", "南港區", "北投區", "內湖區", "士林區", "文山區"]
                },
                {
                    label: "新北市（29個區）",
                    options: ["板橋區", "新莊區", "泰山區", "林口區", "淡水區", "金山區", "八里區", "萬里區", "石門區", "三芝區", "瑞芳區", "汐止區", "平溪區", "貢寮區", "雙溪區", "深坑區", "石碇區", "新店區", "坪林區", "烏來區", "中和區", "永和區", "土城區", "三峽區", "樹林區", "鶯歌區", "三重區", "蘆洲區", "五股區"]
                },
                {
                    label: "桃園市（13個區）",
                    options: ["桃園市", "中壢區", "平鎮區", "龍潭區", "楊梅區", "新屋區", "觀音區", "桃園區", "龜山區", "八德區", "大溪區", "復興區", "大園區", "蘆竹區"]
                },
                {
                    label: "基隆市（7個區）",
                    options: ["仁愛區", "中正區", "信義區", "中山區", "安樂區", "暖暖區", "七堵區"]
                },
                {
                    label: "其他",
                    options: ["外縣市(其他區)"]
                }
            ],
            car: ["A車", "B車", "C車", "D車", "X車", "Y車", "Z車", "其他"]
        };

        const FORM_TITLES = { user: '填表人員', shift: '班別', status: '狀態', owner: '業主', location: '施工地點', car: '車輛' };
        let formData = { date: '', user: '', shift: '', status: '', owner: '', location: '', car: '' };
        let keyboardFocusEl = null;

        function initStartForm() {
            document.getElementById('form-date').valueAsDate = new Date();
            const container = document.getElementById('dynamic-form-sections');
            container.innerHTML = '';
            const order = ['user', 'shift', 'status', 'owner', 'location', 'car'];

            order.forEach(key => {
                const section = document.createElement('section');
                const header = document.createElement('h3');
                header.className = "text-xs font-bold text-slate-500 mb-2 flex items-center gap-1";
                header.innerHTML = `<i data-lucide="circle-dot" class="w-3 h-3"></i> ${FORM_TITLES[key]}`;
                section.appendChild(header);

                const grid = document.createElement('div');
                grid.className = "grid grid-cols-3 sm:grid-cols-4 gap-2";

                if (key === 'location') {
                    grid.className = "space-y-3"; 
                    FORM_OPTIONS.location.forEach(group => {
                        const groupDiv = document.createElement('div');
                        const groupTitle = document.createElement('div');
                        groupTitle.className = "text-[10px] font-bold text-slate-400 mb-1 pl-1 border-l-2 border-slate-300";
                        groupTitle.innerText = group.label;
                        groupDiv.appendChild(groupTitle);
                        const groupGrid = document.createElement('div');
                        groupGrid.className = "grid grid-cols-3 sm:grid-cols-4 gap-2";
                        group.options.forEach(opt => {
                            groupGrid.appendChild(createOptionBtn(key, opt));
                        });
                        groupDiv.appendChild(groupGrid);
                        grid.appendChild(groupDiv);
                    });
                } else {
                    FORM_OPTIONS[key].forEach(opt => {
                        grid.appendChild(createOptionBtn(key, opt));
                    });
                }
                section.appendChild(grid);
                container.appendChild(section);
            });
            lucide.createIcons();
        }

        function createOptionBtn(category, value) {
            const btn = document.createElement('button');
            btn.className = `option-btn nav-item w-full py-2 px-1 rounded-lg border bg-white border-slate-200 text-slate-600 text-sm font-bold shadow-sm hover:bg-slate-50`;
            btn.dataset.category = category;
            btn.dataset.value = value;
            btn.innerText = value;
            btn.onclick = () => selectStartOption(category, value, btn);
            return btn;
        }

        function selectStartOption(category, value, btnElement) {
            formData[category] = value;
            speak(value);
            const container = document.getElementById('dynamic-form-sections');
            const allBtns = container.querySelectorAll(`button[data-category="${category}"]`);
            allBtns.forEach(b => b.classList.remove('selected'));
            btnElement.classList.add('selected');
            btnElement.focus();
            keyboardFocusEl = btnElement;
            updateFocusVisual();
        }

        function goToCalculator() {
            formData.date = document.getElementById('form-date').value;
            const titleEl = document.getElementById('project-title');
            const subtitleEl = document.getElementById('project-subtitle');
            const owner = formData.owner || "未指定業主";
            const loc = formData.location || "未指定地點";
            const date = formData.date || "無日期";
            const user = formData.user || "未簽名";

            titleEl.textContent = `${owner} | ${loc}`;
            subtitleEl.textContent = `${date} | ${user} | ${formData.status || ''}`;

            playStartSound();
            document.getElementById('start-page').classList.remove('page-visible');
            document.getElementById('start-page').classList.add('page-hidden');
            document.getElementById('main-app').classList.remove('page-hidden');
            document.getElementById('main-app').classList.add('page-visible');
            
            keyboardFocusEl = null;
        }

        function backToForm() {
            playBackSound();
            document.getElementById('main-app').classList.remove('page-visible');
            document.getElementById('main-app').classList.add('page-hidden');
            document.getElementById('start-page').classList.remove('page-hidden');
            document.getElementById('start-page').classList.add('page-visible');
            keyboardFocusEl = null;
        }

        function handleKeyboardNav(e) {
            const keys = ['w', 'a', 's', 'd', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
            if (e.key === ' ') {
                e.preventDefault();
                if (keyboardFocusEl) {
                    keyboardFocusEl.click();
                    if (keyboardFocusEl?.tagName === 'INPUT') keyboardFocusEl.focus();
                }
                return;
            }
            if (!keys.includes(e.key)) return;

            const isStartPage = document.getElementById('start-page').classList.contains('page-visible');
            let navItems = isStartPage ? 
                Array.from(document.querySelectorAll('#start-page .nav-item, #start-page input, #start-page button.option-btn')) : 
                Array.from(document.querySelectorAll('#type-list-container button'));
            
            navItems = navItems.filter(el => el.offsetParent !== null && !el.disabled);
            if (navItems.length === 0) return;

            if (!keyboardFocusEl || !document.body.contains(keyboardFocusEl) || !navItems.includes(keyboardFocusEl)) {
                keyboardFocusEl = navItems[0];
                updateFocusVisual();
                return;
            }

            const currentRect = keyboardFocusEl.getBoundingClientRect();
            const cx = currentRect.left + currentRect.width / 2;
            const cy = currentRect.top + currentRect.height / 2;
            let bestCandidate = null;
            let minDist = Infinity;

            navItems.forEach(item => {
                if (item === keyboardFocusEl) return;
                const rect = item.getBoundingClientRect();
                const icx = rect.left + rect.width / 2;
                const icy = rect.top + rect.height / 2;
                let valid = false;
                const dy = icy - cy;
                const dx = icx - cx;

                switch(e.key.toLowerCase()) {
                    case 'w': case 'arrowup':    if (dy < -5) valid = true; break;
                    case 's': case 'arrowdown':  if (dy > 5) valid = true; break;
                    case 'a': case 'arrowleft':  if (dx < -5) valid = true; break;
                    case 'd': case 'arrowright': if (dx > 5) valid = true; break;
                }

                if (valid) {
                    let dist = 0;
                    if (['w', 's', 'arrowup', 'arrowdown'].includes(e.key.toLowerCase())) {
                        dist = Math.sqrt(dx*dx*4 + dy*dy); 
                    } else {
                        dist = Math.sqrt(dx*dx + dy*dy*4);
                    }
                    if (dist < minDist) {
                        minDist = dist;
                        bestCandidate = item;
                    }
                }
            });

            if (bestCandidate) {
                e.preventDefault();
                keyboardFocusEl = bestCandidate;
                updateFocusVisual();
                keyboardFocusEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function updateFocusVisual() {
            document.querySelectorAll('.keyboard-focused').forEach(el => el.classList.remove('keyboard-focused'));
            if (keyboardFocusEl) {
                keyboardFocusEl.classList.add('keyboard-focused');
            }
        }

        // ----------------------
        // 2. 主程式資料與邏輯
        // ----------------------
        const CATEGORIES = {
            'A': 'A. 10cm道路標線',
            'B': 'B. 15cm道路標線',
            'C': 'C. 40cm道路標線',
            'D': 'D. 停等區與車格類標線',
            'E': 'E. 字模標線',
            'F': 'F. 內外型標線',
            'G': 'G. 其他與未分類、自訂義',
            'H': 'H. 非標線施工項目'
        };

        const INITIAL_TYPES = [
            { id: 'white_line', name: '白線', category: 'A', type: 'linear', factors: [0.1], color: 'bg-blue-50 border-blue-200 text-blue-800' },
            { id: 'yellow_line', name: '黃線', category: 'A', type: 'linear', factors: [0.1], color: 'bg-yellow-50 border-yellow-200 text-yellow-800' },
            { id: 'red_line', name: '紅線', category: 'A', type: 'linear', factors: [0.1], color: 'bg-red-50 border-red-200 text-red-800' },
            { id: 'blue_line', name: '藍線', category: 'A', type: 'linear', factors: [0.1], color: 'bg-blue-50 border-blue-200 text-blue-800' },
            { id: 'double_yellow', name: '雙黃線', category: 'A', type: 'linear', factors: [0.1, 2.0], color: 'bg-yellow-50 border-yellow-200 text-yellow-800' },
            { id: 'double_white', name: '雙白線', category: 'A', type: 'linear', factors: [0.1, 2.0], color: 'bg-gray-50 border-gray-200 text-gray-800' },
            { id: 'diag_ped', name: '對角線行人穿越線', category: 'A', type: 'linear', factors: [0.1], color: 'bg-gray-50 border-gray-200 text-gray-800' },
            { id: 'bike_line', name: '自行車道線', category: 'A', type: 'linear', factors: [0.1], color: 'bg-blue-50 border-blue-200 text-blue-800' },
            { id: 'cross_road', name: '岔路線', category: 'A', type: 'linear', factors: [0.1], color: 'bg-gray-50 border-gray-200 text-gray-800' },
            { id: 'white_dot', name: '白點線', category: 'A', type: 'count', factors: [4.0, 0.1], color: 'bg-teal-50 border-teal-200 text-teal-800' },
            { id: 'yellow_dot', name: '黃點線', category: 'A', type: 'count', factors: [4.0, 0.1], color: 'bg-yellow-50 border-yellow-200 text-yellow-800' },
            { id: 'white_edge', name: '白邊線', category: 'B', type: 'linear', factors: [0.15], color: 'bg-blue-50 border-blue-200 text-blue-800' },
            { id: 'wait_zone_border', name: '待轉區', category: 'B', type: 'linear', factors: [0.15], color: 'bg-purple-50 border-purple-200 text-purple-800' },
            { id: 'bus_box_15', name: '15cm公車格', category: 'B', type: 'linear', factors: [0.15], color: 'bg-purple-50 border-purple-200 text-purple-800' },
            { id: 'guide_point', name: '引導線', category: 'B', type: 'count', factors: [0.1, 0.5], color: 'bg-teal-50 border-teal-200 text-teal-800' },
            { id: 'dash_point', name: '穿越虛線', category: 'B', type: 'count', factors: [0.15, 1.0], color: 'bg-gray-50 border-gray-200 text-gray-800' },
            { id: 'stop_line', name: '停止線', category: 'C', type: 'linear', factors: [0.4], color: 'bg-red-50 border-red-200 text-red-800' },
            { id: 'zebra_1m', name: '1m行穿線', category: 'C', type: 'count', factors: [1.0, 0.4], color: 'bg-gray-50 border-gray-200 text-gray-800' },
            { id: 'zebra_2m', name: '2m行穿線', category: 'C', type: 'count', factors: [2.0, 0.4], color: 'bg-gray-50 border-gray-200 text-gray-800' },
            { id: 'zebra_3m', name: '3m行穿線', category: 'C', type: 'count', factors: [3.0, 0.4], color: 'bg-gray-50 border-gray-200 text-gray-800' },
            { id: 'zebra_4m', name: '4m行穿線', category: 'C', type: 'count', factors: [4.0, 0.4], color: 'bg-gray-50 border-gray-200 text-gray-800' },
            { id: 'zebra_5m', name: '5m行穿線', category: 'C', type: 'count', factors: [5.0, 0.4], color: 'bg-gray-50 border-gray-200 text-gray-800' },
            { id: 'checker_board', name: '40cm黃棋盤標線', category: 'C', type: 'count', factors: [0.4, 0.4], color: 'bg-yellow-100 border-yellow-300 text-yellow-900' },
            { id: 'checker_board_80', name: '80cm黃棋盤標線', category: 'C', type: 'count', factors: [0.8, 0.4], color: 'bg-yellow-100 border-yellow-300 text-yellow-900' },
            { id: 'wait_zone_v_dbl', name: '停等區直(雙)', category: 'D', type: 'linear', factors: [0.1, 2.0], color: 'bg-purple-50 border-purple-200 text-purple-800' },
            { id: 'wait_zone_h_dbl', name: '停等區橫(雙)', category: 'D', type: 'linear', factors: [0.2, 2.0], color: 'bg-purple-50 border-purple-200 text-purple-800' },
            { id: 'wait_zone_v_sgl', name: '停等區直', category: 'D', type: 'linear', factors: [0.1, 1.0], color: 'bg-purple-50 border-purple-200 text-purple-800' },
            { id: 'wait_zone_h_sgl', name: '停等區橫', category: 'D', type: 'linear', factors: [0.2, 1.0], color: 'bg-purple-50 border-purple-200 text-purple-800' },
            { id: 'scooter_box', name: '機車格', category: 'D', type: 'linear', factors: [0.1], color: 'bg-indigo-50 border-indigo-200 text-indigo-800' },
            { id: 'car_box', name: '汽車格', category: 'D', type: 'linear', factors: [0.1], color: 'bg-indigo-50 border-indigo-200 text-indigo-800' },
            { id: 'truck_box', name: '貨車格', category: 'D', type: 'linear', factors: [0.1], color: 'bg-indigo-50 border-indigo-200 text-indigo-800' },
            { id: 'taxi_box', name: '計程車格', category: 'D', type: 'linear', factors: [0.1], color: 'bg-indigo-50 border-indigo-200 text-indigo-800' },
            { id: 'dis_scooter_box', name: '殘障機車格', category: 'D', type: 'linear', factors: [0.1], color: 'bg-indigo-50 border-indigo-200 text-indigo-800' },
            { id: 'dis_car_box', name: '殘障汽車格', category: 'D', type: 'linear', factors: [0.1], color: 'bg-indigo-50 border-indigo-200 text-indigo-800' },
            { id: 'bus_box', name: '公車格', category: 'D', type: 'linear', factors: [0.1], color: 'bg-indigo-50 border-indigo-200 text-indigo-800' },
            { id: 'fire_box', name: '消防空間引框', category: 'D', type: 'linear', factors: [0.1], color: 'bg-red-50 border-red-200 text-red-800' },
            { id: 'arrow_idx', name: '指標箭頭', category: 'E', type: 'count', factors: [1.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'arrow_point', name: '小指向箭', category: 'E', type: 'count', factors: [1.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'arrow_3', name: '3m²指向箭', category: 'E', type: 'count', factors: [3.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'arrow_5', name: '5m²指向箭', category: 'E', type: 'count', factors: [5.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'arrow_7', name: '7m²指向箭', category: 'E', type: 'count', factors: [7.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'arrow_9', name: '9m²指向箭', category: 'E', type: 'count', factors: [9.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'bike_s', name: '小自行車符號', category: 'E', type: 'count', factors: [1.5], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'bike', name: '自行車符號', category: 'E', type: 'count', factors: [2.7], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'scooter_sym', name: '機車符號', category: 'E', type: 'count', factors: [3.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'dis_scooter_sym', name: '殘障機車符號', category: 'E', type: 'count', factors: [2.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'dis_car_sym', name: '殘障汽車符號', category: 'E', type: 'count', factors: [3.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'spec_lane_sym', name: '專用道符號', category: 'E', type: 'count', factors: [2.5], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'ped_sym', name: '行人符號', category: 'E', type: 'count', factors: [3.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'yield_sym', name: '讓路符號', category: 'E', type: 'count', factors: [3.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'zigzag', name: '鋸齒型標線', category: 'E', type: 'count', factors: [2.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'speed_30', name: '限速30', category: 'E', type: 'count', factors: [2.5], color: 'bg-red-50 border-red-200 text-red-800' },
            { id: 'speed_40', name: '限速40', category: 'E', type: 'count', factors: [2.5], color: 'bg-red-50 border-red-200 text-red-800' },
            { id: 'speed_50', name: '限速50', category: 'E', type: 'count', factors: [2.5], color: 'bg-red-50 border-red-200 text-red-800' },
            { id: 'time_num', name: '時間號碼', category: 'E', type: 'count', factors: [12.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'hot_num', name: '車格號碼熱拌', category: 'E', type: 'count', factors: [1.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'paint_num', name: '油漆車格號碼', category: 'E', type: 'count', factors: [0.5], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_class', name: '上課時間字', category: 'E', type: 'count', factors: [1.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_stop', name: '時段性禁停字', category: 'E', type: 'count', factors: [1.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_scooter', name: '機慢車待轉區字', category: 'E', type: 'count', factors: [1.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_wait', name: '待轉區字', category: 'E', type: 'count', factors: [2.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_slow', name: '慢字', category: 'E', type: 'count', factors: [2.5], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_stop_word', name: '停字', category: 'E', type: 'count', factors: [2.5], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_ban', name: '禁行機車字', category: 'E', type: 'count', factors: [2.5], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_road', name: '一般道路字', category: 'E', type: 'count', factors: [2.5], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_fine', name: '越線受罰字', category: 'E', type: 'count', factors: [2.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_bus', name: '公車專用字', category: 'E', type: 'count', factors: [2.5], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_bus_stop', name: '公車停靠區字', category: 'E', type: 'count', factors: [2.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_walk', name: '人行道字', category: 'E', type: 'count', factors: [2.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_taxi', name: '計程車專用字', category: 'E', type: 'count', factors: [2.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_truck', name: '貨車裝卸專用區字', category: 'E', type: 'count', factors: [1.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_taxi_stand', name: '計程車招呼站字', category: 'E', type: 'count', factors: [1.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'grid_in', name: '黃網線內', category: 'F', type: 'linear', factors: [0.1], color: 'bg-yellow-100 border-yellow-300 text-yellow-900' },
            { id: 'grid_out', name: '黃網線外', category: 'F', type: 'linear', factors: [0.2], color: 'bg-yellow-100 border-yellow-300 text-yellow-900' },
            { id: 'white_chev_15', name: '15cm白槽化線外', category: 'F', type: 'linear', factors: [0.15], color: 'bg-gray-50 border-gray-300 text-gray-700' },
            { id: 'white_chev_out', name: '白槽化線外', category: 'F', type: 'linear', factors: [0.1], color: 'bg-gray-50 border-gray-300 text-gray-700' },
            { id: 'white_chev_in', name: '白槽化線內', category: 'F', type: 'linear', factors: [0.2], color: 'bg-gray-50 border-gray-300 text-gray-700' },
            { id: 'yellow_chev_15', name: '15cm黃槽化線外', category: 'F', type: 'linear', factors: [0.15], color: 'bg-yellow-100 border-yellow-300 text-yellow-900' },
            { id: 'yellow_chev_out', name: '黃槽化線外', category: 'F', type: 'linear', factors: [0.1], color: 'bg-yellow-100 border-yellow-300 text-yellow-900' },
            { id: 'yellow_chev_in', name: '黃槽化線內', category: 'F', type: 'linear', factors: [0.2], color: 'bg-yellow-100 border-yellow-300 text-yellow-900' },
            { id: 'wedge', name: '楔形減速標線', category: 'G', type: 'count', factors: [1.0, 0.3], color: 'bg-orange-50 border-orange-200 text-orange-800' },
            { id: 'rumble', name: '跳動路面', category: 'G', type: 'linear', factors: [0.1, 2.0, 6.0], color: 'bg-orange-50 border-orange-200 text-orange-800' },
            { id: 'blind', name: '導盲線', category: 'G', type: 'linear', factors: [0.05, 2.0, 3.0], color: 'bg-orange-50 border-orange-200 text-orange-800' },
            { id: 'color_mark', name: '彩色標線', category: 'G', type: 'linear', factors: [0.1], color: 'bg-pink-50 border-pink-200 text-pink-800' },
            { id: 'mma', name: '冷塑型MMA高耐磨止滑料', category: 'G', type: 'linear', factors: [0.1], color: 'bg-blue-100 border-blue-300 text-blue-900' },
            { id: 'mma_text', name: '冷塑型MMA人行道字樣及圖示', category: 'G', type: 'count', factors: [1.0], color: 'bg-blue-100 border-blue-300 text-blue-900' },
            { id: 'cat_yellow', name: '黃貓眼', category: 'H', type: 'item', factors: [1.0], color: 'bg-amber-100 border-amber-300 text-amber-900' },
            { id: 'cat_white', name: '白貓眼', category: 'H', type: 'item', factors: [1.0], color: 'bg-slate-200 border-slate-400 text-slate-800' },
            { id: 'bollard', name: '防撞桿', category: 'H', type: 'item', factors: [1.0], color: 'bg-orange-100 border-orange-300 text-orange-900' },
        ];

        let types = [];
        let selectedTypeId = '';
        let inputValue = '';
        let historyData = [];
        
        let currentPrefixMode = 'mark'; 
        const PREFIX_MAP = {
            'mark': '',
            'primer': '底油',
            'remove': '刨除',
            'black': '黑漆',
            'color': '彩標',
            'cold': '冷塑'
        };

        function loadTypes() {
            let stored = JSON.parse(localStorage.getItem('marking_types'));
            if (!stored || !Array.isArray(stored) || (stored.length > 0 && (!stored[0].factors || !stored[0].category))) {
                types = JSON.parse(JSON.stringify(INITIAL_TYPES));
            } else {
                const customItems = stored.filter(t => t.id.startsWith('custom_'));
                customItems.forEach(item => { if (!item.category) item.category = 'G'; });
                types = [...JSON.parse(JSON.stringify(INITIAL_TYPES)), ...customItems];
            }
            if (types.length > 0) {
                const exists = types.find(t => t.id === selectedTypeId);
                if (!exists) selectedTypeId = types[0].id;
            }
            localStorage.setItem('marking_types', JSON.stringify(types));
        }

        function resetTypes() {
            if(confirm('確定要載入新的施工項目清單嗎？(您的自訂項目將會被移除)')) {
                types = JSON.parse(JSON.stringify(INITIAL_TYPES));
                localStorage.setItem('marking_types', JSON.stringify(types));
                selectedTypeId = types[0].id;
                renderTypes();
                updateScreen();
            }
        }

        function fmtNum(num) {
            return parseFloat(num.toFixed(2));
        }

        function getUnitName(type) {
            if (type.type === 'item') return '個/支'; 
            if (type.type === 'linear') return 'm';
            if (type.name.includes('行穿線')) return '條'; 
            if (type.name.includes('字') || type.id.includes('text') || type.id.includes('word')) return '字';
            if (type.name.includes('點') || type.id.includes('dot')) return '點';
            if (type.name.includes('條')) return '條';
            if (type.name.includes('支')) return '支';
            if (type.name.includes('貓眼')) return '個';
            if (type.name.includes('桿')) return '支';
            return '組';
        }

        function getFactorProduct(factors) {
            return factors.reduce((acc, cur) => acc * cur, 1);
        }

        function fmtFactors(factors, typeObj) {
            const name = typeObj.name || '';
            const id = typeObj.id || (typeof typeObj === 'string' ? typeObj : '');
            
            if (typeObj.type === 'item') return '';

            if ((name.includes('行穿線') || id === 'zebra_cross') && factors.length > 0) {
                 const f0 = fmtNum(factors[0]);
                 const rest = factors.slice(1).map(f => fmtNum(f));
                 if (rest.length > 0) return `${f0}m*${rest.join('*')}`;
                 return `${f0}m`;
            }
            return factors.map(f => fmtNum(f)).join('*');
        }
        
        function getSelectedType() {
            return types.find(t => t.id === selectedTypeId) || types[0];
        }

        function init() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', onDomReady);
            } else {
                onDomReady();
            }
        }
        
        function onDomReady() {
            initStartForm();
            loadTypes();
            renderTypes();
            updateScreen();
            lucide.createIcons();

            document.addEventListener('keydown', (e) => {
                if(document.getElementById('start-page').classList.contains('page-visible')) {
                    handleKeyboardNav(e);
                    return;
                }
                const isInput = document.activeElement?.tagName === 'INPUT' || document.activeElement?.tagName === 'TEXTAREA';
                if (!isInput) {
                    if(e.key >= '0' && e.key <= '9') { inputKey(e.key); return; }
                    if(e.key === '.') { inputKey('.'); return; }
                    if(e.key === 'Backspace') { inputKey('DEL'); return; }
                    if(e.key === 'Escape') { inputKey('AC'); return; }
                    if(e.key === 'Enter') { e.preventDefault(); submitInput(); return; }
                    if(e.key === ' ') { e.preventDefault(); if(keyboardFocusEl) keyboardFocusEl.click(); return; }
                    if(e.key.toLowerCase() === 's' && e.altKey) { e.preventDefault(); saveProgress(); return; }
                    if(e.key.toLowerCase() === 'r' && e.altKey) { e.preventDefault(); loadProgress(); return; }
                    if(e.key.toLowerCase() === 'p') { e.preventDefault(); copyReport(); return; }
                    if(e.key.toLowerCase() === 'o') { e.preventDefault(); copyLineItems(); return; }
                    if(e.key.toLowerCase() === 'l') { e.preventDefault(); exportPDF(); return; }
                }
                handleKeyboardNav(e);
            });
            
            document.getElementById('custom-name').addEventListener('input', updateCustomPreview);
            document.getElementById('custom-factors').addEventListener('input', updateCustomPreview);
            document.getElementById('custom-type').addEventListener('change', updateCustomPreview);
        }

        function setPrefixMode(mode) {
            currentPrefixMode = mode;
            ['mark', 'primer', 'remove', 'black', 'color', 'cold'].forEach(m => {
                const btn = document.getElementById(`btn-mode-${m}`);
                if (m === mode) {
                    btn.classList.add('mode-btn-active');
                    btn.classList.remove('mode-btn-inactive');
                } else {
                    btn.classList.add('mode-btn-inactive');
                    btn.classList.remove('mode-btn-active');
                }
            });
            const badge = document.getElementById('screen-prefix-badge');
            const prefixText = PREFIX_MAP[mode];
            if (prefixText) {
                badge.textContent = prefixText;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function renderTypes() {
            const container = document.getElementById('type-list-container');
            container.innerHTML = '';
            const catKeys = Object.keys(CATEGORIES);

            catKeys.forEach(catKey => {
                const catItems = types.filter(t => t.category === catKey);
                if (catItems.length > 0) {
                    const section = document.createElement('div');
                    const header = document.createElement('h3');
                    header.className = "text-xs font-bold text-slate-400 mb-2 pl-1 border-l-4 border-slate-300";
                    header.innerText = CATEGORIES[catKey];
                    section.appendChild(header);

                    const grid = document.createElement('div');
                    grid.className = "grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-1.5";

                    catItems.forEach(type => {
                        const btn = document.createElement('button');
                        const isSelected = type.id === selectedTypeId;
                        const unit = getUnitName(type);
                        const factorProd = getFactorProduct(type.factors);
                        
                        let formulaText = `1${unit}×${fmtFactors(type.factors, type)}=${fmtNum(factorProd)}m²`;
                        if (type.type === 'item') {
                            formulaText = `統計數量 (不計面積)`;
                        }

                        btn.className = `
                            type-btn relative p-1 rounded-lg border-2 text-left transition-all btn-active flex flex-col justify-between h-14 shadow-sm bg-white
                            ${isSelected ? 'border-blue-500 ring-2 ring-blue-200 bg-white z-10' : `${type.color} border-transparent hover:opacity-90`}
                        `;
                        btn.dataset.id = type.id;
                        btn.onclick = () => {
                            selectType(type.id);
                            speak(type.name);
                            btn.focus();
                            keyboardFocusEl = btn;
                            updateFocusVisual();
                        };
                        btn.innerHTML = `
                            <div class="font-bold text-xs leading-tight break-words line-clamp-2">${type.name}</div>
                            <div class="text-[9px] opacity-70 mt-0.5 font-mono bg-white/50 inline-block px-1 rounded break-all leading-tight truncate w-full">${formulaText}</div>
                            ${isSelected ? '<div class="absolute top-0.5 right-0.5 w-1.5 h-1.5 bg-blue-500 rounded-full animate-pulse"></div>' : ''}
                        `;
                        grid.appendChild(btn);
                    });
                    section.appendChild(grid);
                    container.appendChild(section);
                }
            });

            const addSection = document.createElement('div');
            addSection.className = "mt-4 pt-4 border-t border-slate-200";
            const addBtn = document.createElement('button');
            addBtn.className = "w-full p-2 rounded-lg border-2 border-dashed border-slate-300 text-slate-400 flex items-center justify-center gap-2 hover:bg-slate-50 hover:text-slate-600 transition-colors h-12";
            addBtn.onclick = openModal;
            addBtn.innerHTML = `<i data-lucide="plus" class="w-4 h-4"></i><span class="text-xs font-bold">新增自訂項目 (將歸類於 G 區)</span>`;
            addSection.appendChild(addBtn);
            container.appendChild(addSection);
            lucide.createIcons();
            
            if (selectedTypeId) {
                const activeBtn = container.querySelector(`button[data-id="${selectedTypeId}"]`);
                if (activeBtn) {
                    keyboardFocusEl = activeBtn;
                    updateFocusVisual();
                }
            }
        }

        function selectType(id) { selectedTypeId = id; inputValue = ''; renderTypes(); updateScreen(); }

        function editCurrentFactors() {
            const type = getSelectedType();
            if(!type) return;
            if (type.category === 'H' || type.type === 'item') { alert('此項目為純數量統計，無需設定面積係數。'); return; }
            const currentStr = type.factors.map(f => fmtNum(f)).join('*'); 
            const newStr = prompt(`修改 "${type.name}" 的計算參數 (例如: 長度*寬度):\n目前設定: ${currentStr}`, currentStr);
            if(newStr !== null && newStr !== currentStr) {
                const newFactors = parseFactors(newStr);
                if(newFactors.length > 0) {
                    type.factors = newFactors;
                    localStorage.setItem('marking_types', JSON.stringify(types));
                    renderTypes();
                    updateScreen();
                } else { alert('格式錯誤，請輸入數字或算式 (例如: 3.5*0.4)'); }
            }
        }

        function inputKey(key) {
            if (key === 'AC') inputValue = '';
            else if (key === 'DEL') inputValue = inputValue.slice(0, -1);
            else if (key === '.') { if (!inputValue.includes('.')) inputValue += key; }
            else { if (inputValue.length < 8) inputValue += key; }
            updateScreen();
        }

        function updateScreen() {
            const type = getSelectedType();
            const val = parseFloat(inputValue);
            document.getElementById('screen-type-name').innerText = type.name;
            const displayVal = inputValue || '0';
            document.getElementById('screen-value').innerText = displayVal;
            let unitLabel = '組';
            if (type.type === 'item') {
                 if (type.name.includes('桿')) unitLabel = '支';
                 else if (type.name.includes('貓眼')) unitLabel = '個';
                 else unitLabel = '個';
            } else {
                 const u = getUnitName(type);
                 unitLabel = type.type === 'linear' ? 'm (長度)' : `${u} (數量)`;
            }
            document.getElementById('screen-unit').innerText = unitLabel;
            const previewEl = document.getElementById('screen-calc-preview');
            previewEl.innerText = '';
            if (val > 0) {
                if (type.type === 'item') {
                    previewEl.innerText = `統計數量: ${val} ${unitLabel.split(' ')[0]}`;
                } else {
                    const totalFactor = getFactorProduct(type.factors);
                    const area = val * totalFactor;
                    const factorStr = fmtFactors(type.factors, type);
                    const formula = `${fmtNum(val)}${unitLabel.split(' ')[0]} × ${factorStr} = ${fmtNum(area)} m²`;
                    previewEl.innerText = formula;
                }
            }
        }

        // 新增功能：加入分區
        function addPartition() {
            const name = prompt("請輸入分區名稱 (例如: A區):");
            if (name && name.trim()) {
                const finalName = `(${name.trim()}).`;
                const newItem = {
                    id: Date.now(),
                    typeId: 'partition_marker',
                    name: finalName,
                    category: 'partition', // 特殊分類
                    inputType: 'partition',
                    factors: [],
                    inputValue: 0,
                    area: 0
                };
                historyData = [newItem, ...historyData];
                renderHistory();
            }
        }

        function submitInput() {
            const val = parseFloat(inputValue);
            const type = getSelectedType();
            if (!type || isNaN(val) || val <= 0) return;
            playDingDong();
            const totalFactor = getFactorProduct(type.factors);
            const area = (type.type === 'item') ? 0 : val * totalFactor;
            const prefix = PREFIX_MAP[currentPrefixMode];
            const finalName = prefix ? `${prefix} ${type.name}` : type.name;
            const newItem = {
                id: Date.now(),
                typeId: type.id,
                name: finalName, 
                category: type.category,
                inputType: type.type,
                factors: [...type.factors], 
                inputValue: val,
                area: area
            };
            historyData = [newItem, ...historyData];
            inputValue = '';
            updateScreen();
            renderHistory();
            setTimeout(() => {
                const activeBtn = document.querySelector(`button[data-id="${type.id}"]`);
                if(activeBtn) { activeBtn.focus(); keyboardFocusEl = activeBtn; updateFocusVisual(); }
            }, 50);
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            const totalEl = document.getElementById('display-total-area');
            list.innerHTML = '';
            let total = 0;
            if (historyData.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-400 mt-4 text-xs">暫無資料</div>';
            } else {
                historyData.forEach(item => {
                    const el = document.createElement('div');
                    
                    // 特殊渲染：分區分隔線
                    if (item.category === 'partition') {
                        el.className = "bg-gray-200 p-1 rounded border border-gray-300 flex justify-between items-center shadow-inner mt-1 mb-1";
                        el.innerHTML = `
                            <div class="font-bold text-gray-700 text-xs w-full text-center">${item.name}</div>
                            <button onclick="deleteItem(${item.id})" class="text-gray-400 hover:text-red-500 p-0.5 rounded ml-2">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        `;
                    } else {
                        total += item.area;
                        el.className = "bg-white p-1.5 rounded border border-slate-200 flex justify-between items-center animate-fadeIn gap-2 shadow-sm";
                        const factorStr = fmtFactors(item.factors, {name: item.name, id: item.typeId, type: item.inputType});
                        let unit = getUnitName({ type: item.inputType, id: item.typeId, name: item.name });
                        if(item.inputType === 'item') {
                             if (item.name.includes('桿')) unit = '支';
                             else unit = '個';
                        }
                        let detailHtml = '';
                        let rightHtml = '';
                        if (item.inputType === 'item') {
                            detailHtml = `輸入: ${fmtNum(item.inputValue)}${unit}`;
                            rightHtml = `<div class="font-mono font-bold text-slate-500 text-xs">數量</div>`;
                        } else {
                            detailHtml = `輸入: ${fmtNum(item.inputValue)}${unit} <span class="text-slate-300">|</span> 係: ${factorStr}`;
                            rightHtml = `<div class="font-mono font-bold text-blue-600 text-xs">${fmtNum(item.area)}</div>`;
                        }
                        el.innerHTML = `
                            <div class="overflow-hidden flex-1 min-w-0">
                                <div class="flex items-baseline gap-2">
                                    <span class="font-bold text-slate-700 text-xs truncate leading-tight">${item.name}</span>
                                </div>
                                <div class="text-[10px] text-slate-500 truncate leading-tight mt-0.5">${detailHtml}</div>
                            </div>
                            <div class="text-right flex items-center gap-1.5 shrink-0">
                                ${rightHtml}
                                <button onclick="deleteItem(${item.id})" class="text-slate-300 hover:text-red-500 p-1 active:bg-slate-100 rounded">
                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                </button>
                            </div>
                        `;
                    }
                    list.appendChild(el);
                });
            }
            totalEl.innerText = fmtNum(total);
            lucide.createIcons();
        }

        function deleteItem(id) { historyData = historyData.filter(i => i.id !== id); renderHistory(); }
        function clearAll() { if(confirm('確定要清空所有紀錄嗎？')) { historyData = []; renderHistory(); } }
        function openModal() { document.getElementById('modal-custom').classList.remove('hidden'); updateCustomLabels(); }
        function closeModal() { document.getElementById('modal-custom').classList.add('hidden'); document.getElementById('custom-name').value = ''; document.getElementById('custom-factors').value = ''; }
        function updateCustomLabels() { updateCustomPreview(); }
        function parseFactors(str) { if(!str) return []; return str.split(/[\*\sx]+/).map(s => parseFloat(s)).filter(n => !isNaN(n) && n > 0); }
        function updateCustomPreview() {
            const type = document.getElementById('custom-type').value;
            const factorStr = document.getElementById('custom-factors').value;
            const factors = parseFactors(factorStr);
            const previewEl = document.getElementById('custom-preview');
            if (type === 'item') { previewEl.innerText = "純數量統計 (無面積)"; return; }
            if (factors.length === 0) { previewEl.innerText = `1${type === 'linear' ? 'm' : '點'} * ? = ? m²`; return; }
            const totalFactor = getFactorProduct(factors);
            const displayFactors = fmtFactors(factors, {name: 'custom'});
            previewEl.innerText = type === 'linear' ? `1m * ${displayFactors} = ${fmtNum(totalFactor)} m²` : `1點 * ${displayFactors} = ${fmtNum(totalFactor)} m²`;
        }
        function saveCustomType() {
            const name = document.getElementById('custom-name').value.trim();
            const typeMode = document.getElementById('custom-type').value;
            const factorStr = document.getElementById('custom-factors').value;
            const factors = parseFactors(factorStr);
            if (typeMode !== 'item' && (!name || factors.length === 0)) { alert('請輸入正確的名稱與係數算式 (例如 0.1 或 1.0*0.5)'); return; }
            if (typeMode === 'item' && !name) { alert('請輸入項目名稱'); return; }
            const finalFactors = (typeMode === 'item' && factors.length === 0) ? [1.0] : factors;
            const newType = { id: 'custom_' + Date.now(), name: name, category: typeMode === 'item' ? 'H' : 'G', type: typeMode, factors: finalFactors, color: typeMode === 'item' ? 'bg-amber-100 border-amber-300 text-amber-900' : 'bg-purple-50 border-purple-200 text-purple-800' };
            types.push(newType); localStorage.setItem('marking_types', JSON.stringify(types));
            renderTypes(); closeModal(); selectType(newType.id);
        }

        // 新增：儲存進度功能
        function saveProgress() {
            if (historyData.length === 0 && !formData.date) {
                alert('無資料可儲存');
                return;
            }
            const data = {
                timestamp: Date.now(),
                formData: formData,
                historyData: historyData,
                types: types // 儲存自定義項目
            };
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // 檔名格式：施工日期-班別-填表人員-狀態-業主-施工地點-車輛
            const dateStr = formData.date || new Date().toISOString().split('T')[0];
            const shiftStr = formData.shift || '未填班別';
            const userStr = formData.user || '未填人員';
            const statusStr = formData.status || '未填狀態';
            const ownerStr = formData.owner || '未填業主';
            const locationStr = formData.location || '未填地點';
            const carStr = formData.car || '未填車輛';

            // 組合檔名，並過濾掉可能導致檔名錯誤的特殊字元
            let filename = `${dateStr}-${shiftStr}-${userStr}-${statusStr}-${ownerStr}-${locationStr}-${carStr}`;
            filename = filename.replace(/[\\/:*?"<>|]/g, '_'); // 將不合法字元替換為底線
            filename += '.json';

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("檔案儲存成功！");
        }

        // 新增：讀取進度功能 (觸發 input)
        function loadProgress() {
            document.getElementById('file-input').click();
        }

        // 新增：處理檔案讀取
        function handleFileLoad(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('確定要載入此檔案嗎？目前的資料將會被覆蓋！')) {
                        // 還原資料
                        if (data.formData) formData = data.formData;
                        if (data.historyData) historyData = data.historyData;
                        if (data.types) {
                            types = data.types;
                            localStorage.setItem('marking_types', JSON.stringify(types));
                            renderTypes(); // 重新渲染按鈕以包含自定義項目
                        }

                        // 更新畫面
                        // 如果在前置頁面，更新輸入框
                        if (document.getElementById('start-page').classList.contains('page-visible')) {
                            if (formData.date) document.getElementById('form-date').value = formData.date;
                            // 重新選取按鈕
                            const sections = ['user', 'shift', 'status', 'owner', 'location', 'car'];
                            sections.forEach(sec => {
                                const val = formData[sec];
                                if (val) {
                                    const btn = document.querySelector(`button[data-category="${sec}"][data-value="${val}"]`);
                                    if (btn) {
                                        // 清除舊選取
                                        document.querySelectorAll(`button[data-category="${sec}"]`).forEach(b => b.classList.remove('selected'));
                                        btn.classList.add('selected');
                                    }
                                }
                            });
                        } else {
                            // 如果在主畫面，更新標題與列表
                            const titleEl = document.getElementById('project-title');
                            const subtitleEl = document.getElementById('project-subtitle');
                            const owner = formData.owner || "未指定業主";
                            const loc = formData.location || "未指定地點";
                            const date = formData.date || "無日期";
                            const user = formData.user || "未簽名";
                            titleEl.textContent = `${owner} | ${loc}`;
                            subtitleEl.textContent = `${date} | ${user} | ${formData.status || ''}`;
                            renderHistory();
                        }
                        
                        // 若在主畫面也需要重繪列表
                        renderHistory();
                        showToast("檔案讀取成功！");
                    }
                } catch (err) {
                    alert('檔案格式錯誤或損毀');
                    console.error(err);
                }
                // 清空 input 讓下次選同檔也能觸發
                input.value = '';
            };
            reader.readAsText(file);
        }

        function copyLineItems() {
            if (historyData.length === 0) { alert('請先輸入統計資料'); return; }
            playVictory();
            const lines = [...historyData].reverse().map(item => {
                if (item.category === 'partition') return item.name; // 直接輸出分區名稱
                let unit = '組';
                if (item.inputType === 'linear') unit = 'm';
                else if (item.inputType === 'item') unit = (item.name.includes('桿')) ? '支' : '個'; 
                else {
                    if (item.name.includes('行穿線')) unit = '條';
                    else if (item.name.includes('字') || item.typeId.includes('text')) unit = '字';
                    else if (item.name.includes('點')) unit = '點';
                    else if (item.name.includes('條')) unit = '條';
                    else if (item.name.includes('支')) unit = '支';
                    else if (item.name.includes('貓眼')) unit = '個';
                    else if (item.name.includes('桿')) unit = '支';
                    else unit = '組'; 
                    if (unit === '組' && (item.name.includes('箭') || item.name.includes('符號'))) unit = '個';
                }
                return `${item.name}${fmtNum(item.inputValue)}${unit}`;
            });
            const text = lines.join('\n');
            const textarea = document.createElement("textarea");
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try { document.execCommand('copy'); showToast("逐條複製成功！"); } catch (err) { alert('複製失敗'); }
            document.body.removeChild(textarea);
        }

        // 修改：複製報表支援分區邏輯 (修正為 Map 合併)
        function copyReport() {
            if (historyData.length === 0) { alert('請先輸入統計資料'); return; }
            playVictory();
            let text = `【道路標線施工日報表】\n日期: ${formData.date || '未填寫'}\n人員: ${formData.user || '未填寫'} | 班別: ${formData.shift || '未填寫'} | 狀態: ${formData.status || '未填寫'}\n業主: ${formData.owner || '未填寫'} | 車輛: ${formData.car || '未填寫'}\n地點: ${formData.location || '未填寫'}\n------------------------\n`; 
            
            // 使用 Map 進行分區合併
            const partitionMap = new Map();
            let currentPartitionName = "預設區";

            // 初始化或獲取分區物件
            const getPartition = (name) => {
                if (!partitionMap.has(name)) {
                    partitionMap.set(name, { name: name, items: [], totalArea: 0 });
                }
                return partitionMap.get(name);
            };

            // 遍歷歷史資料 (由舊到新)
            [...historyData].reverse().forEach(item => {
                if (item.category === 'partition') {
                    currentPartitionName = item.name;
                } else {
                    const part = getPartition(currentPartitionName);
                    part.items.push(item);
                    part.totalArea += (item.area || 0);
                }
            });

            // 將 Map 轉為 Array 進行輸出
            const partitions = Array.from(partitionMap.values());

            partitions.forEach(part => {
                if(part.name !== "預設區") text += `\n【${part.name}】\n`;
                
                const sections = { mark: { label: '標線', groups: {} }, primer: { label: '底油', groups: {} }, remove: { label: '刨除', groups: {} }, black: { label: '黑漆', groups: {} }, color: { label: '彩標', groups: {} }, cold: { label: '冷塑', groups: {} } };
                const itemsH = {}; 

                part.items.forEach(item => {
                    if (item.category === 'H' || item.inputType === 'item') {
                        if (!itemsH[item.name]) itemsH[item.name] = { values: [] };
                        itemsH[item.name].values.push(item.inputValue);
                    } else {
                        let sectionKey = 'mark';
                        if (item.name.startsWith('底油 ')) sectionKey = 'primer';
                        else if (item.name.startsWith('刨除 ')) sectionKey = 'remove';
                        else if (item.name.startsWith('黑漆 ')) sectionKey = 'black';
                        else if (item.name.startsWith('彩標 ')) sectionKey = 'color';
                        else if (item.name.startsWith('冷塑 ')) sectionKey = 'cold';
                        const sec = sections[sectionKey];
                        if (!sec.groups[item.name]) sec.groups[item.name] = { items: [], type: item.inputType, typeId: item.typeId, factors: item.factors, totalArea: 0 };
                        sec.groups[item.name].items.push(item.inputValue);
                        sec.groups[item.name].totalArea += item.area;
                    }
                });

                const generateSectionText = (key) => {
                    const sec = sections[key];
                    const groupNames = Object.keys(sec.groups);
                    if (groupNames.length === 0) return '';
                    let sectionText = ''; const groupAreas = []; let sectionTotalArea = 0;
                    groupNames.forEach(name => {
                        const g = sec.groups[name];
                        const values = g.items;
                        const sum = values.reduce((a, b) => a + b, 0);
                        const sumFmt = fmtNum(sum);
                        const factorStr = fmtFactors(g.factors, {name: name, id: g.typeId});
                        const areaFmt = fmtNum(g.totalArea);
                        const unit = getUnitName({ type: g.type, id: g.typeId, name: name });
                        if (values.length > 1) { const valJoined = values.map(v => fmtNum(v)).join('+'); sectionText += `${name}:(${valJoined})=${sumFmt}${unit}*${factorStr}=${areaFmt}m²\n`; } 
                        else { sectionText += `${name}:${sumFmt}${unit}*${factorStr}=${areaFmt}m²\n`; }
                        groupAreas.push(areaFmt); sectionTotalArea += g.totalArea;
                    });
                    sectionText += `\n`; let totalFormula = "";
                    if (groupAreas.length > 1) totalFormula = `(${groupAreas.join('+')})=`;
                    sectionText += `${sec.label}總計:${totalFormula}${fmtNum(sectionTotalArea)}m²\n------------------------\n`;
                    return sectionText;
                };

                text += generateSectionText('mark'); text += generateSectionText('primer'); text += generateSectionText('remove'); text += generateSectionText('black'); text += generateSectionText('color'); text += generateSectionText('cold');
                
                if (Object.keys(itemsH).length > 0) {
                    text += `【非標線施工項目】\n`;
                    Object.keys(itemsH).forEach(name => {
                        const values = itemsH[name].values;
                        const sum = values.reduce((a, b) => a + b, 0);
                        const sumFmt = fmtNum(sum);
                        let unit = name.includes('桿') ? '支' : '個';
                        if (values.length > 1) { const valJoined = values.map(v => fmtNum(v)).join('+'); text += `${name}總計:(${valJoined})=${sumFmt}${unit}\n`; } 
                        else { text += `${name}:${sumFmt}${unit}\n`; }
                    });
                }
            });

            const textarea = document.createElement("textarea"); textarea.value = text; document.body.appendChild(textarea); textarea.select();
            try { document.execCommand('copy'); showToast("報表複製成功！"); } catch (err) { alert('複製失敗'); }
            document.body.removeChild(textarea);
        }

        // 修改後的 PDF 輸出邏輯：View Swapping + Partition Aggregation + Clipping Fix
        function exportPDF() {
            if (historyData.length === 0) { alert('請先輸入統計資料'); return; }
            playVictory();
            
            let dateStr = formData.date || '未填寫';
            if(dateStr !== '未填寫') dateStr = dateStr.replace(/-/g, '/');
            const shiftStr = formData.shift || '';
            const mergedDate = shiftStr ? `${dateStr}-${shiftStr}` : dateStr;

            document.getElementById('pdf-date').innerText = mergedDate;
            document.getElementById('pdf-owner').innerText = formData.owner || '未填寫';
            document.getElementById('pdf-user').innerText = formData.user || '未填寫';
            document.getElementById('pdf-status').innerText = formData.status || '未填寫';
            document.getElementById('pdf-location').innerText = formData.location || '未填寫';
            document.getElementById('pdf-car').innerText = formData.car || '未填寫';

            const leftCol = document.getElementById('pdf-left-col');
            leftCol.innerHTML = '';
            
            // 分區處理 (Map 聚合)
            const partitionMap = new Map();
            let currentPartitionName = "預設區";
            let totalProjectArea = 0;

            const getPartition = (name) => {
                if (!partitionMap.has(name)) {
                    partitionMap.set(name, { name: name, items: [], totalArea: 0 });
                }
                return partitionMap.get(name);
            };

            [...historyData].reverse().forEach(item => {
                if (item.category === 'partition') {
                    currentPartitionName = item.name;
                } else {
                    const part = getPartition(currentPartitionName);
                    part.items.push(item);
                    part.totalArea += (item.area || 0);
                    totalProjectArea += (item.area || 0);
                }
            });
            
            document.getElementById('pdf-total-area').innerText = fmtNum(totalProjectArea);

            const partitions = Array.from(partitionMap.values());

            partitions.forEach(part => {
                const sections = { mark: { label: '標線', groups: {} }, primer: { label: '底油', groups: {} }, remove: { label: '刨除', groups: {} }, black: { label: '黑漆', groups: {} }, color: { label: '彩標', groups: {} }, cold: { label: '冷塑', groups: {} } };
                const itemsH = {}; 

                // 如果有特定分區名稱，顯示標題
                if(part.name !== "預設區") {
                    const header = document.createElement('div');
                    header.className = "font-bold text-base bg-blue-100 text-blue-900 p-1 mb-2 mt-4 border-l-4 border-blue-600";
                    header.innerText = part.name;
                    leftCol.appendChild(header);
                }

                part.items.forEach(item => {
                    if (item.category === 'H' || item.inputType === 'item') {
                        if (!itemsH[item.name]) itemsH[item.name] = { values: [] };
                        itemsH[item.name].values.push(item.inputValue);
                    } else {
                        let sectionKey = 'mark';
                        if (item.name.startsWith('底油 ')) sectionKey = 'primer';
                        else if (item.name.startsWith('刨除 ')) sectionKey = 'remove';
                        else if (item.name.startsWith('黑漆 ')) sectionKey = 'black';
                        else if (item.name.startsWith('彩標 ')) sectionKey = 'color';
                        else if (item.name.startsWith('冷塑 ')) sectionKey = 'cold';
                        const sec = sections[sectionKey];
                        if (!sec.groups[item.name]) sec.groups[item.name] = { items: [], type: item.inputType, typeId: item.typeId, factors: item.factors, totalArea: 0 };
                        sec.groups[item.name].items.push(item.inputValue);
                        sec.groups[item.name].totalArea += item.area;
                    }
                });

                const appendSectionHtml = (key) => {
                    const sec = sections[key];
                    const groupNames = Object.keys(sec.groups);
                    if (groupNames.length === 0) return;
                    const wrapper = document.createElement('div');
                    wrapper.className = 'pdf-section mb-2';
                    let html = `<div class="font-bold border-b border-gray-300 mb-1">${sec.label}</div>`;
                    let sectionTotal = 0;
                    const sectionAreas = [];

                    groupNames.forEach(name => {
                        const g = sec.groups[name];
                        const values = g.items;
                        const sum = values.reduce((a, b) => a + b, 0);
                        const areaFmt = fmtNum(g.totalArea);
                        sectionAreas.push(areaFmt);
                        const unit = getUnitName({ type: g.type, id: g.typeId, name: name });
                        const factorStr = fmtFactors(g.factors, {name: name, id: g.typeId});
                        let valStr = values.length > 1 ? `(${values.map(v=>fmtNum(v)).join('+')})=${fmtNum(sum)}` : fmtNum(sum);
                        html += `<div class="flex justify-between"><span>${name}: ${valStr}${unit} × ${factorStr}</span><span>= ${areaFmt} m²</span></div>`;
                        sectionTotal += g.totalArea;
                    });
                    let totalFormula = "";
                    if (sectionAreas.length > 1) { totalFormula = `(${sectionAreas.join('+')})=`; }
                    html += `<div class="text-right font-bold mt-1 border-t border-dotted border-gray-400 pt-1">${sec.label}總計: ${totalFormula}${fmtNum(sectionTotal)} m²</div>`;
                    wrapper.innerHTML = html;
                    leftCol.appendChild(wrapper);
                };
                appendSectionHtml('mark'); appendSectionHtml('primer'); appendSectionHtml('remove'); appendSectionHtml('black'); appendSectionHtml('color'); appendSectionHtml('cold');

                if (Object.keys(itemsH).length > 0) {
                    const wrapper = document.createElement('div'); wrapper.className = 'pdf-section mt-2';
                    let html = `<div class="font-bold border-b border-gray-300 mb-1">非標線施工項目</div>`;
                    Object.keys(itemsH).forEach(name => {
                        const values = itemsH[name].values;
                        const sum = values.reduce((a, b) => a + b, 0);
                        let unit = name.includes('桿') ? '支' : '個';
                        let valStr = values.length > 1 ? `(${values.map(v=>fmtNum(v)).join('+')})` : '';
                        html += `<div class="flex justify-between"><span>${name} ${valStr}</span><span>= ${fmtNum(sum)} ${unit}</span></div>`;
                    });
                    wrapper.innerHTML = html; leftCol.appendChild(wrapper);
                }
            });

            // 填充右欄
            const rightCol = document.getElementById('pdf-right-col'); rightCol.innerHTML = '';
            document.getElementById('pdf-count-badge').innerText = `共 ${historyData.length} 筆`;
            [...historyData].reverse().forEach(item => {
                const li = document.createElement('li');
                if (item.category === 'partition') {
                    li.innerText = item.name;
                    li.style.fontWeight = 'bold';
                    li.style.marginTop = '8px';
                    li.style.listStyle = 'none'; // 分區標題不顯示編號
                    li.style.marginLeft = '-1em';
                } else {
                    let unit = '組';
                    if (item.inputType === 'linear') unit = 'm';
                    else if (item.inputType === 'item') unit = (item.name.includes('桿')) ? '支' : '個';
                    else {
                        if (item.name.includes('行穿線')) unit = '條';
                        else if (item.name.includes('字') || item.typeId.includes('text')) unit = '字';
                        else if (item.name.includes('點')) unit = '點';
                        else if (item.name.includes('貓眼')) unit = '個';
                        else if (item.name.includes('箭')) unit = '個';
                    }
                    li.innerText = `${item.name} ${fmtNum(item.inputValue)}${unit}`;
                }
                rightCol.appendChild(li);
            });

            // --- 切換視圖模式 ---
            const template = document.getElementById('pdf-template');
            document.body.classList.add('pdf-mode');
            window.scrollTo(0, 0); 
            showToast("正在生成 PDF...", false);

            const opt = {
                margin: 10,
                filename: `${formData.date}_${formData.owner}_${formData.location}_${formData.user}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0, windowWidth: document.body.scrollWidth }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            setTimeout(() => {
                html2pdf().set(opt).from(template).output('blob').then((blob) => {
                    document.body.classList.remove('pdf-mode');
                    const file = new File([blob], opt.filename, { type: 'application/pdf' });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        navigator.share({
                            files: [file],
                            title: '道路標線施工數量表',
                            text: '這是您的標線統計報表 PDF'
                        }).then(() => { showToast("分享成功！"); }).catch((err) => { if (err.name !== 'AbortError') forceDownload(blob, opt.filename); });
                    } else { forceDownload(blob, opt.filename); }
                }).catch(err => {
                    console.error(err);
                    document.body.classList.remove('pdf-mode');
                    alert("PDF 生成失敗");
                });
            }, 800);
        }

        function forceDownload(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            showToast("PDF 下載成功！(請檢查檔案App)");
        }

        function showToast(msg, autoHide = true) {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            if(msg) { toast.querySelector('.font-bold').innerText = msg; msgEl.style.display = 'none'; } 
            else { toast.querySelector('.font-bold').innerText = "操作成功！"; msgEl.style.display = 'block'; }
            toast.classList.remove('hidden'); toast.classList.add('flex');
            if(autoHide) { setTimeout(() => { toast.classList.add('hidden'); toast.classList.remove('flex'); }, 2000); }
        }

        init();
        
        const style = document.createElement('style');
        style.textContent = `
            .key-btn { border-radius: 0.5rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-weight: 700; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; display: flex; align-items: center; justify-content: center; }
            .key-btn:active { transform: translateY(2px); box-shadow: none; }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
            .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
